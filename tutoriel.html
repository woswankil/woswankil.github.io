<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tutoriels - Alliance WOS</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
  <header>
    <div class="container">
      <h1>Alliance Wankil Whiteout Survival 1911</h1>
      <nav>
        <a href="index.html">Accueil</a>
        <a href="membres.html">Membres</a>
        <a href="sheet.html">Tableau d'event</a>
        <a href="tutoriel.html" class="active">Tutoriel</a>
        <a href="reglement.html">Règlement</a>
      </nav>
    </div>
    <div class="language-switcher">
      <a href="lang/en/index_en.html">
        <img src="data/en-flag.png" alt="English" style="width:50px; height:auto;" />
      </a>
    </div>
  </header>

  <main>
    <section class="hero">
      <h2>Nos Tutoriels</h2>
    </section>

    <section class="content">
      <div id="tuto-buttons">
        <!-- Boutons générés ici -->
      </div>
      <div id="tuto-content">
        <p>Sélectionnez un tutoriel ci-dessus pour commencer.</p>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 Alliance WOS - Tous droits réservés.</p>
    </div>
  </footer>

  <script>

    async function chargerListeTutoriels() {
      try {
        const res = await fetch('data/tutorial/index.json');
        if (!res.ok) throw new Error("Index tutoriels non trouvé");
        return await res.json();
      } catch (e) {
        console.error("Erreur chargement index :", e);
        return null;
      }
    }

    async function chargerTuto(fichier) {
      try {
        const res = await fetch(`data/tutorial/${fichier}`);
        if (!res.ok) throw new Error("Tutoriel introuvable");
        return await res.json();
      } catch (e) {
        console.error("Erreur chargement tutoriel :", e);
        return null;
      }
    }

    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function genererHTML(contenu) {
      try {
        return contenu.map(el => {
          if (el.type === "html") {
            return el.data; // Contenu déjà sécurisé côté serveur
          } else if (el.type === "text") {
            return `<p>${escapeHTML(el.data)}</p>`;
          } else if (el.type === "image") {
            return `<img src="${escapeHTML(el.data)}" alt="Illustration du tutoriel">`;
          } else {
            console.warn("Type inconnu :", el.type);
            return "";
          }
        }).join('\n');
      } catch (e) {
        console.error("Erreur dans genererHTML :", e);
        return "<p>Erreur affichage contenu.</p>";
      }
    }

    async function initTutoriels() {
      const containerBtns = document.getElementById('tuto-buttons');
      const containerContenu = document.getElementById('tuto-content');

      const tutoriels = await chargerListeTutoriels();
      if (!tutoriels || tutoriels.length === 0) {
        containerContenu.innerHTML = "<p>Aucun tutoriel disponible.</p>";
        return;
      }

      containerBtns.innerHTML = '';
      let boutonActif = null;

      tutoriels.forEach(({ id, titre, fichier }, i) => {
        const btn = document.createElement('button');
        btn.textContent = titre;
        btn.addEventListener('click', async () => {
          if (boutonActif) boutonActif.classList.remove('active');
          btn.classList.add('active');
          boutonActif = btn;

          containerContenu.innerHTML = "<p>Chargement...</p>";
          const tuto = await chargerTuto(fichier);
          if (tuto && Array.isArray(tuto.contenu)) {
            containerContenu.innerHTML = genererHTML(tuto.contenu);
          } else {
            containerContenu.innerHTML = "<p>Erreur chargement du tutoriel.</p>";
          }
        });
        containerBtns.appendChild(btn);

        if (i === 0) btn.click();
      });
    }

    document.addEventListener('DOMContentLoaded', initTutoriels);
  </script>
</body>
</html>
